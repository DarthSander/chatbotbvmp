<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Geboorteplan-agent</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    /* ---------- Kleurenpalet & basis stijl ---------- */
    :root {
      --rose: #d5848d;
      --rose-light: #e8a8b0;
      --sage: #8cbf9d;
      --sage-light: #cfe6d0;
      --cream: #fef9f5;
      --beige: #fdf7f2;
      --rose-sub: #fbeaec;
      --text: #2d3436;
      --text-light: #636e72;
      --grad-main: linear-gradient(135deg, var(--cream), var(--beige) 50%, var(--rose-sub) 100%);
      --grad-rose: linear-gradient(135deg, var(--rose), var(--rose-light));
      --shadow: 0 6px 22px rgba(0, 0, 0, .1);
    }
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      font-family: Inter, system-ui, sans-serif;
      background: var(--grad-main);
      color: var(--text);
      line-height: 1.55;
    }
    /* Layout containers */
    #layout {
      display: flex;
      flex-direction: row;
      gap: 24px;
      height: 100%;
      padding: 16px;
      box-sizing: border-box;
    }
    @media (max-width: 900px) {
      #layout {
        flex-direction: column;
        padding: 0 !important;
      }
    }
    /* Chat column */
    #chat-col {
      flex: 3;
      display: flex;
      flex-direction: column;
      max-height: 100%;
    }
    @media (max-width: 900px) {
      #chat-col {
        display: none !important;
      }
    }
    #chatbox, #mobile-chatbox {
      flex: 1;
      overflow-y: auto;
      padding-right: 8px;
    }
    .bubble {
      padding: 12px 16px;
      margin: 8px 0;
      border-radius: 12px;
      max-width: 80%;
      line-height: 1.4;
      word-wrap: break-word;
      box-shadow: var(--shadow);
    }
    .bubble.user {
      background: #fff;
      margin-left: auto;
    }
    .bubble.bot {
      background: var(--rose-sub);
      margin-right: auto;
    }
    .mae-thinking {
      opacity: 0.7;
      font-style: italic;
    }
    #choices, #mobile-choices {
      margin-top: auto;
      padding-bottom: 8px;
    }
    #input-area, #mobile-input-area {
      display: flex;
      gap: 8px;
      margin-top: auto;
      border-top: 1px solid #ddd;
      padding: 8px 0;
    }
    #input, #mobile-input {
      flex: 1;
      border: none;
      padding: 10px;
      font-size: 16px;
      border-radius: 4px;
      box-sizing: border-box;
      font-family: inherit;
    }
    #input:focus, #mobile-input:focus {
      outline: 2px solid var(--rose);
    }
    #send, #mobile-send {
      background: var(--rose);
      color: #fff;
      border: none;
      padding: 0 16px;
      font-size: 16px;
      border-radius: 4px;
      cursor: pointer;
    }
    #send:hover, #mobile-send:hover {
      background: var(--rose-light);
    }

    /* ---------- Chips ---------- */
    #q-options, #mobile-q-options,
    #q-topic-options, #mobile-q-topic-options {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin: 16px 0;
    }
    .theme-chip, .topic-chip {
      padding: 8px 16px;
      border-radius: 9999px;
      font-size: 14px;
      cursor: pointer;
      user-select: none;
      position: relative;
    }
    .theme-chip {
      border: 1px solid var(--rose);
      color: var(--rose);
      background: #fff;
    }
    .theme-chip:hover {
      background: var(--grad-rose);
      color: #fff;
      border-color: transparent;
    }
    .theme-chip.selected {
      background: linear-gradient(135deg, var(--sage), var(--sage-light));
      color: #fff;
      border: none;
    }
    .theme-chip .edit-bar {
      display: inline-block;
      margin-left: 8px;
      font-weight: bold;
      font-size: 14px;
      pointer-events: none;
    }
    .topic-chip {
      border: 1px solid var(--sage);
      color: var(--sage);
      background: #fff;
    }
    .topic-chip:hover {
      transform: translateY(-2px);
    }
    .topic-chip.selected {
      background: linear-gradient(135deg, var(--sage), var(--sage-light));
      color: #fff;
      border: 0;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    /* Tooltip voor onderwerpbeschrijving */
    .topic-chip[data-desc]:hover::after {
      content: attr(data-desc);
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      top: 110%;
      background: var(--rose-light);
      color: #fff;
      padding: 6px 10px;
      border-radius: 8px;
      white-space: nowrap;
      font-size: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,.15);
      z-index: 20;
      text-align: center;
    }
    .topic-chip[data-desc]:hover::before {
      content: "";
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      top: 100%;
      border: 6px solid transparent;
      border-top-color: var(--rose-light);
      z-index: 21;
    }
    /* Disabled state voor overschrijding limieten */
    .theme-chip.disabled, .topic-chip.disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .theme-chip.disabled:hover::after {
      content: "Maximaal 6 thema's bereikt";
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      top: 110%;
      background: var(--rose-light);
      color: #fff;
      padding: 6px 10px;
      border-radius: 8px;
      white-space: nowrap;
      font-size: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,.15);
      z-index: 20;
      text-align: center;
    }
    .theme-chip.disabled:hover::before {
      content: "";
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      top: 100%;
      border: 6px solid transparent;
      border-top-color: var(--rose-light);
      z-index: 21;
    }
    .topic-chip.disabled:hover::after {
      content: "Maximaal 4 onderwerpen bereikt";
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      top: 110%;
      background: var(--rose-light);
      color: #fff;
      padding: 6px 10px;
      border-radius: 8px;
      white-space: nowrap;
      font-size: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,.15);
      z-index: 20;
      text-align: center;
    }
    .topic-chip.disabled:hover::before {
      content: "";
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      top: 100%;
      border: 6px solid transparent;
      border-top-color: var(--rose-light);
      z-index: 21;
    }

    /* ---------- Sidebar (desktop) ---------- */
    #sidebar-flip-container {
      flex: 2;
      display: flex;
      flex-direction: column;
      height: 100%;
      position: relative;
    }
    @media (max-width: 900px) {
      #sidebar-flip-container {
        display: none !important;
      }
    }
    .flip-container {
      width: 100%;
      height: 100%;
      perspective: 1000px;
      position: relative;
    }
    .sidebar-face {
      position: absolute;
      width: 100%;
      height: 100%;
      backface-visibility: hidden;
      overflow-y: auto;
      padding: 20px;
      box-sizing: border-box;
      border-radius: 16px;
      background: #fff;
    }
    .sidebar-face.front {
      /* voorzijde (thema selectie/QA) */
    }
    .sidebar-face.topics {
      transform: rotateY(180deg);
      background: #fff;
    }
    .flip-container.flipped-to-topics .front {
      transform: rotateY(180deg);
    }
    .flip-container.flipped-to-topics .topics {
      transform: rotateY(0);
    }
    .sidebar-face.qa {
      /* aparte face voor volledige Q&A */
      display: none;
    }

    /* ---------- Overige UI elementen ---------- */
    h4, h5 {
      margin: 0 0 12px;
    }
    button.confirm-button {
      background: var(--sage);
      color: #fff;
      border: none;
      padding: 10px 16px;
      font-size: 15px;
      border-radius: 4px;
      cursor: pointer;
    }
    button.confirm-button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    button.back-button {
      background: none;
      border: none;
      color: var(--rose);
      font-size: 16px;
      margin-bottom: 12px;
      cursor: pointer;
    }
    .loader-container {
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      margin-bottom: 16px;
    }
    .loader {
      width: 32px;
      height: 32px;
      border: 4px solid #ccc;
      border-top-color: var(--sage);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .progress-bar {
      width: 80%;
      height: 6px;
      background: #f1f1f1;
      border-radius: 3px;
      margin-top: 8px;
      overflow: hidden;
    }
    .progress-fill {
      width: 0;
      height: 100%;
      background: var(--sage);
      transition: width 0.3s ease;
    }

    /* ---------- Mobiele weergave ---------- */
    #mobile-tabs {
      display: none;
    }
    @media (max-width: 900px) {
      #mobile-tabs {
        display: flex;
        border-bottom: 1px solid #ddd;
      }
      #mobile-tabs button {
        flex: 1;
        padding: 12px;
        background: #f9f9f9;
        border: none;
        font-size: 16px;
        cursor: pointer;
      }
      #mobile-tabs button.active {
        background: #fff;
        font-weight: 600;
      }
    }
    .mobile-face {
      display: none;
      height: calc(100% - 50px);
      overflow-y: auto;
      padding: 16px;
      box-sizing: border-box;
      background: #fff;
    }
    .mobile-face.active {
      display: block;
    }
    #mobile-chat-face {
      display: flex;
      flex-direction: column;
      height: 100%;
    }
    #qa-log-mobile p {
      margin-top: 8px;
    }
  </style>
</head>
<body>
  <!-- Mobiele tabknoppen -->
  <div id="mobile-tabs">
    <button id="tab-chat" class="active">Chat</button>
    <button id="tab-themes">Thema's</button>
    <button id="tab-topics">Onderwerpen</button>
    <button id="tab-qa">Q&A</button>
  </div>

  <main id="layout">
    <!-- Chat kolom (desktop) -->
    <div id="chat-col">
      <div id="chatbox"></div>
      <div id="choices"></div>
      <div id="input-area">
        <textarea id="input" placeholder="Typ je bericht…"></textarea>
        <button id="send">Verstuur</button>
      </div>
    </div>

    <!-- Sidebar container (desktop) -->
    <div id="sidebar-flip-container">
      <div id="sidebar-loader" style="display:none;"><div class="loader"></div></div>
      <div class="flip-container" id="desktop-flip-container">
        <!-- Voorzijde: thema's en (ingekorte) Q&A -->
        <aside class="sidebar-face front" id="sidebar-front">
          <h4 id="q-title"></h4>
          <div id="q-options"></div>
          <hr />
          <h5>Antwoorden</h5>
          <div id="qa-log-desktop"></div>
          <button id="view-all-qa" class="confirm-button" style="margin-top:20px;">Bekijk alle Vragen & Antwoorden →</button>
        </aside>
        <!-- Achterzijde: onderwerpen voor huidig thema -->
        <aside class="sidebar-face topics" id="sidebar-topics">
          <button id="back-to-themes" class="back-button">← Terug naar thema's</button>
          <h4 id="back-title"></h4>
          <div id="topic-loader" class="loader-container" style="display:none;">
            <div class="loader"></div>
            <div class="progress-bar"><div class="progress-fill" id="progress-fill"></div></div>
          </div>
          <div id="q-topic-options"></div>
          <button id="confirm-topics" class="confirm-button" disabled>Bevestig onderwerpen →</button>
        </aside>
        <!-- Q&A volledig overzicht -->
        <aside class="sidebar-face qa" id="sidebar-qa-desktop">
          <button id="back-from-qa-desktop" class="back-button">← Terug</button>
          <h4>Jouw Vragen & Antwoorden</h4>
          <div id="qa-log-full-desktop"></div>
        </aside>
      </div>
    </div>

    <!-- Laadindicator voor mobiele overlay -->
    <div id="mobile-loader" style="display:none;"><div class="loader"></div></div>

    <!-- Mobiele card-flip container -->
    <div id="mobile-flip-container">
      <!-- Mobiel: chat face -->
      <div class="mobile-face active" id="mobile-chat-face">
        <div id="mobile-chatbox"></div>
        <div id="mobile-choices"></div>
        <div id="mobile-input-area">
          <textarea id="mobile-input" placeholder="Typ je bericht…"></textarea>
          <button id="mobile-send">Verstuur</button>
        </div>
      </div>
      <!-- Mobiel: themakeuze face -->
      <div class="mobile-face" id="mobile-themes-face">
        <h4 id="mobile-q-title"></h4>
        <div id="mobile-q-options"></div>
      </div>
      <!-- Mobiel: onderwerpen face -->
      <div class="mobile-face" id="mobile-topics-face">
        <button id="mobile-back-to-themes" class="back-button">← Terug naar thema's</button>
        <h4 id="mobile-back-title"></h4>
        <div id="mobile-topic-loader" class="loader-container" style="display:none;">
          <div class="loader"></div>
          <div class="progress-bar"><div class="progress-fill" id="mobile-progress-fill"></div></div>
        </div>
        <div id="mobile-q-topic-options"></div>
        <button id="mobile-confirm-topics" class="confirm-button" disabled>Bevestig onderwerpen →</button>
      </div>
      <!-- Mobiel: volledige Q&A face -->
      <div class="mobile-face" id="mobile-qa-face">
        <button id="mobile-back-from-qa" class="back-button">← Terug</button>
        <h4>Jouw Vragen & Antwoorden</h4>
        <div id="qa-log-mobile"></div>
      </div>
    </div>
  </main>

  <script>
    // Initialiseer applicatie na DOM load
    window.addEventListener('DOMContentLoaded', () => {
      // Globale variabelen
      const API_URL = "https://chatbotbvmp.onrender.com/agent";
      let sessionId = sessionStorage.getItem("agentSession") || null;
      let currentTheme = null;
      let selectedTopicsForTheme = {};  // houdt per thema de gekozen onderwerpen bij

      // Verwijzing naar DOM elementen
      const ui = {
        chatbox: document.getElementById("chatbox"),
        mobileChatbox: document.getElementById("mobile-chatbox"),
        input: document.getElementById("input"),
        mobileInput: document.getElementById("mobile-input"),
        sendBtn: document.getElementById("send"),
        mobileSendBtn: document.getElementById("mobile-send"),
        qOptions: document.getElementById("q-options"),
        mobileQOptions: document.getElementById("mobile-q-options"),
        qTitle: document.getElementById("q-title"),
        mobileQTitle: document.getElementById("mobile-q-title"),
        topicOptions: document.getElementById("q-topic-options"),
        mobileTopicOptions: document.getElementById("mobile-q-topic-options"),
        backTitle: document.getElementById("back-title"),
        mobileBackTitle: document.getElementById("mobile-back-title"),
        confirmTopicsBtn: document.getElementById("confirm-topics"),
        mobileConfirmTopicsBtn: document.getElementById("mobile-confirm-topics"),
        desktopFlipContainer: document.getElementById("desktop-flip-container"),
        mobileFlipContainer: document.getElementById("mobile-flip-container"),
        sidebarLoader: document.getElementById("sidebar-loader"),
        mobileLoader: document.getElementById("mobile-loader"),
        qaLogDesktop: document.getElementById("qa-log-desktop"),
        qaLogFullDesktop: document.getElementById("qa-log-full-desktop"),
        qaLogMobile: document.getElementById("qa-log-mobile"),
        qaTabButton: document.getElementById("tab-qa")
      };

      // Functies voor chatbubbles en typ-indicator
      window.addMsg = function(role, markdown, chatboxElem) {
        if (!chatboxElem) return null;
        const bubble = document.createElement("div");
        bubble.className = `bubble ${role === "bot" ? "bot" : "user"}`;
        bubble.innerHTML = marked.parse(markdown);
        chatboxElem.appendChild(bubble);
        chatboxElem.scrollTop = chatboxElem.scrollHeight;
        return bubble;
      }
      window.typingBubble = function(chatboxElem) {
        const bubbleElement = addMsg("bot", "Mae is aan het nadenken...", chatboxElem);
        if (!bubbleElement) return { element: null };
        bubbleElement.classList.add('mae-thinking');
        return { element: bubbleElement };
      }

      // Laadindicator tonen/verbergen
      window.showLoader = function(isMobile) {
        const loader = isMobile ? ui.mobileLoader : ui.sidebarLoader;
        if (loader) loader.style.display = 'flex';
      }
      window.hideLoader = function(isMobile) {
        const loader = isMobile ? ui.mobileLoader : ui.sidebarLoader;
        if (loader) loader.style.display = 'none';
      }

      // API-aanroep functie (agent)
      window.callAgent = async function(message, currentSessionId) {
        const isMobile = window.innerWidth <= 900;
        const chatboxElem = isMobile ? ui.mobileChatbox : ui.chatbox;
        const waitIndicator = typingBubble(chatboxElem);
        showLoader(isMobile);
        try {
          const response = await fetch(API_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ message, session_id: currentSessionId })
          });
          // Verwijder typ-indicator bubble als nog aanwezig
          if (waitIndicator.element && chatboxElem.contains(waitIndicator.element)) {
            chatboxElem.removeChild(waitIndicator.element);
          }
          if (!response.ok) {
            const errorText = await response.text();
            console.error("Server Error Response:", errorText);
            throw new Error(`Server Error: ${response.status}`);
          }
          const data = await response.json();
          return data;
        } catch(err) {
          console.error('[callAgent] Fout:', err);
          addMsg("bot", "⚠️ Oeps, er is een technische fout opgetreden. Probeer het later opnieuw.", chatboxElem);
          throw err;
        } finally {
          hideLoader(isMobile);
        }
      }

      // Thema-chips renderen (max 6 selectie)
      window.renderThemes = function(options, selectedThemes, isMobile) {
        const box = isMobile ? ui.mobileQOptions : ui.qOptions;
        const title = isMobile ? ui.mobileQTitle : ui.qTitle;
        if (!box || !title) return;
        box.innerHTML = "";
        title.textContent = "Kies een thema (max 6):";
        options.forEach(themeName => {
          const chip = document.createElement("span");
          chip.className = "theme-chip";
          chip.textContent = themeName;
          const isSelected = selectedThemes.some(s => s.name === themeName);
          if (isSelected) {
            chip.classList.add("selected");
            // Potlood icoon voor reeds gekozen thema
            const editIcon = document.createElement("span");
            editIcon.className = "edit-bar";
            editIcon.textContent = "✎";
            chip.appendChild(editIcon);
          }
          if (!isSelected && selectedThemes.length >= 6) {
            // Max aantal thema's bereikt, deze chip uitschakelen
            chip.classList.add("disabled");
            // (Geen onclick om te voorkomen dat er iets gebeurt bij klikken)
          } else {
            chip.onclick = () => {
              // Stuur thema-naam naar agent (geen user-bubble weergeven)
              handleChoice(themeName, false);
            };
          }
          box.appendChild(chip);
        });
      }

      // Verwerking API-response: render keuzes of schakel weergaven
      async function callAndRender(msg) {
        const isMobile = window.innerWidth <= 900;
        try {
          const data = await callAgent(msg, sessionId);
          // Sessie ID eventueel bijwerken/opslagen
          sessionId = data.session_id;
          sessionStorage.setItem("agentSession", sessionId);
          // Toon eventueel het agent-antwoord in de chat
          const chatboxElem = isMobile ? ui.mobileChatbox : ui.chatbox;
          if (data.assistant_reply) {
            addMsg("bot", data.assistant_reply, chatboxElem);
          }
          // Update Q&A-lijst als meegeleverd
          logQA(data.qa);
          // Schakel UI op basis van nieuwe fase
          if (data.stage === "choose_theme" && data.options) {
            if (isMobile) switchMobileFace('themes');
            renderThemes(data.options, data.themes || [], isMobile);
          } else if (data.stage === "choose_topic" && data.options && data.current_theme) {
            currentTheme = data.current_theme;
            if (ui.backTitle) ui.backTitle.textContent = `Onderwerpen voor “${currentTheme}”`;
            if (ui.mobileBackTitle) ui.mobileBackTitle.textContent = `Onderwerpen voor “${currentTheme}”`;
            if (isMobile) {
              switchMobileFace('topics');
            } else {
              ui.desktopFlipContainer.classList.add("flipped-to-topics");
            }
            const previouslySelected = (data.topics && data.topics[currentTheme]) || [];
            // Even wachten op flip-animatie (0.4s) voordat we chips tonen
            setTimeout(() => {
              renderTopicChips(data.options, previouslySelected, isMobile);
            }, 400);
          }
        } catch (err) {
          console.error('[callAndRender] Fout bij verwerken API data:', err);
        }
      }

      // Verwerk gebruikersinvoer (versturen)
      async function handleChoice(txt, showBubble = true) {
        if (!txt.trim()) return;
        const isMobile = window.innerWidth <= 900;
        const chatboxElem = isMobile ? ui.mobileChatbox : ui.chatbox;
        const inputElem = isMobile ? ui.mobileInput : ui.input;
        if (showBubble) {
          addMsg("user", txt, chatboxElem);
        }
        if (inputElem) inputElem.value = "";
        // Centrale afhandeling via callAndRender
        await callAndRender(txt);
      }

      // Onderwerp-chips renderen (max 4 selectie per thema)
      window.renderTopicChips = function(options, previouslySelected, isMobile) {
        const box = isMobile ? ui.mobileTopicOptions : ui.topicOptions;
        if (!box) return;
        box.innerHTML = "";
        // Sla huidige selectie intern op
        selectedTopicsForTheme[currentTheme] = [...previouslySelected];
        options.forEach(opt => {
          const chip = document.createElement("span");
          chip.className = "topic-chip";
          chip.textContent = opt.name;
          chip.dataset.desc = opt.description || "";
          const alreadySelected = previouslySelected.includes(opt.name);
          if (alreadySelected) {
            chip.classList.add("selected");
          }
          if (!alreadySelected && previouslySelected.length >= 4) {
            // Max aantal onderwerpen bereikt, disable deze chip
            chip.classList.add("disabled");
          } else {
            chip.onclick = () => {
              const currentSelection = selectedTopicsForTheme[currentTheme] || [];
              const wasMax = currentSelection.length >= 4;
              const wasOneAway = currentSelection.length === 3;
              if (chip.classList.contains("selected")) {
                // Verwijderen van onderwerp
                chip.classList.remove("selected");
                selectedTopicsForTheme[currentTheme] = currentSelection.filter(t => t !== opt.name);
                if (wasMax) {
                  // Was op max, dus her-render om andere chips te activeren
                  setTimeout(() => {
                    renderTopicChips(options, selectedTopicsForTheme[currentTheme], isMobile);
                  }, 0);
                }
              } else {
                if (currentSelection.length < 4) {
                  // Toevoegen van onderwerp
                  chip.classList.add("selected");
                  selectedTopicsForTheme[currentTheme].push(opt.name);
                  if (wasOneAway) {
                    // Nu selectie == 4, her-render om rest te disablen
                    setTimeout(() => {
                      renderTopicChips(options, selectedTopicsForTheme[currentTheme], isMobile);
                    }, 0);
                  }
                }
              }
              updateConfirmButtonState(isMobile);
            };
          }
          box.appendChild(chip);
        });
        updateConfirmButtonState(isMobile);
      }

      // Bevestig-knop aan/uit op basis van selectie
      window.updateConfirmButtonState = function(isMobile) {
        const btn = isMobile ? ui.mobileConfirmTopicsBtn : ui.confirmTopicsBtn;
        const selection = selectedTopicsForTheme[currentTheme] || [];
        if (btn) btn.disabled = selection.length === 0;
      }

      // Verzamel gekozen onderwerpen en stuur naar backend
      async function confirmTopics() {
        const isMobile = window.innerWidth <= 900;
        showLoader(isMobile);
        const selection = selectedTopicsForTheme[currentTheme] || [];
        // Meld elk gekozen onderwerp (stil) aan de backend
        for (const topic of selection) {
          await callAgent(`Onderwerp geselecteerd: ${topic}`, sessionId);
        }
        // Stuur daarna het "klaar met onderwerpen" signaal en toon update
        await handleChoice(`Ik ben klaar met de onderwerpen voor ${currentTheme}.`, true);
        if (isMobile) {
          switchMobileFace('themes');
        } else {
          ui.desktopFlipContainer.classList.remove("flipped-to-topics");
        }
        hideLoader(isMobile);
      }

      // Q&A log bijwerken
      window.logQA = function(qaArray) {
        const qaData = qaArray || [];
        function updateLog(el) {
          if (!el) return;
          el.innerHTML = qaData.map(entry =>
            `<p><strong>${entry.theme} - ${entry.question || entry.name}</strong><br>${entry.answer || 'Nog geen antwoord'}</p>`
          ).join('');
          el.scrollTop = el.scrollHeight;
        }
        updateLog(ui.qaLogDesktop);
        updateLog(ui.qaLogFullDesktop);
        updateLog(ui.qaLogMobile);
        // Markeer het Q&A tabblad indien nieuwe antwoorden beschikbaar zijn
        if (ui.qaTabButton && qaData.length > 0 && !ui.qaTabButton.classList.contains('active')) {
          ui.qaTabButton.classList.add('new-qa');
        }
      }

      // Functie om layout te wisselen tussen desktop/mobiel weergave (indien nodig)
      window.updateLayoutForDevice = function() {
        const isMobile = window.innerWidth <= 900;
        document.getElementById('sidebar-flip-container').style.display = isMobile ? 'none' : 'flex';
        document.getElementById('mobile-flip-container').style.display = isMobile ? 'block' : 'none';
        document.getElementById('mobile-tabs').style.display = isMobile ? 'flex' : 'none';
      }
      window.updateLayoutForDevice();

      // *** Event handlers voor UI-elementen ***
      // Verzendknoppen
      ui.sendBtn.onclick = () => handleChoice(ui.input.value.trim());
      ui.input.addEventListener("keydown", e => { if (e.key === "Enter" && !e.shiftKey) { e.preventDefault(); ui.sendBtn.click(); }});
      ui.mobileSendBtn.onclick = () => handleChoice(ui.mobileInput.value.trim());
      ui.mobileInput.addEventListener("keydown", e => { if (e.key === "Enter" && !e.shiftKey) { e.preventDefault(); ui.mobileSendBtn.click(); }});

      // Thema terugknop (desktop)
      document.getElementById("back-to-themes").onclick = () => {
        // Terug naar themaselectie zonder bevestigen
        ui.desktopFlipContainer.classList.remove("flipped-to-topics");
        // Zet fase terug op choose_theme in de sessie zonder extra call
        handleChoice("Ik wil een ander thema kiezen.", false);
      };
      // Bekijken alle Q&A (desktop)
      document.getElementById("view-all-qa").onclick = () => {
        document.getElementById("sidebar-front").style.display = 'none';
        document.getElementById("sidebar-qa-desktop").style.display = 'block';
      };
      document.getElementById("back-from-qa-desktop").onclick = () => {
        document.getElementById("sidebar-qa-desktop").style.display = 'none';
        document.getElementById("sidebar-front").style.display = 'block';
      };

      // Mobiele navigatietabs
      const faces = {
        chat: document.getElementById("mobile-chat-face"),
        themes: document.getElementById("mobile-themes-face"),
        topics: document.getElementById("mobile-topics-face"),
        qa: document.getElementById("mobile-qa-face")
      };
      window.switchMobileFace = function(faceName) {
        Object.values(faces).forEach(face => face.classList.remove("active"));
        faces[faceName + (faceName.endsWith('s') ? '' : 's') + '-face']?.classList.add("active");
        // Activeer corresponderende tabknop
        document.querySelectorAll("#mobile-tabs button").forEach(btn => btn.classList.remove("active"));
        const tabButton = {
          chat: document.getElementById("tab-chat"),
          themes: document.getElementById("tab-themes"),
          topics: document.getElementById("tab-topics"),
          qa: document.getElementById("tab-qa")
        }[faceName];
        if (tabButton) tabButton.classList.add("active");
      };
      document.getElementById("tab-chat").onclick = () => switchMobileFace('chat');
      document.getElementById("tab-themes").onclick = () => switchMobileFace('themes');
      document.getElementById("tab-topics").onclick = () => switchMobileFace('topics');
      document.getElementById("tab-qa").onclick = () => { 
        switchMobileFace('qa');
        ui.qaTabButton.classList.remove('new-qa');
      };
      document.getElementById("mobile-back-to-themes").onclick = () => switchMobileFace('themes');
      document.getElementById("mobile-back-from-qa").onclick = () => switchMobileFace('chat');

      // Bevestig-knoppen voor onderwerpen (desktop & mobiel)
      ui.confirmTopicsBtn.onclick = confirmTopics;
      ui.mobileConfirmTopicsBtn.onclick = confirmTopics;

      // Start de conversatie automatisch (optioneel)
      handleChoice("Ik ben klaar om thema’s te kiezen.", false);
    });
  </script>
</body>
</html>
