<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Geboorteplan-agent</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <style>
    /* ---------- palet & basis ---------- */
    :root {
      --rose: #d5848d;
      --rose-light: #e8a8b0;
      --sage: #8cbf9d;
      --sage-light: #cfe6d0;
      --cream: #fef9f5;
      --beige: #fdf7f2;
      --rose-sub: #fbeaec;
      --text: #2d3436;
      --text-light: #636e72;
      --grad-main: linear-gradient(135deg, var(--cream), var(--beige) 50%, var(--rose-sub) 100%);
      --grad-rose: linear-gradient(135deg, var(--rose), var(--rose-light));
      --shadow: 0 6px 22px rgba(0, 0, 0, .1);
    }
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      font-family: Inter, system-ui, sans-serif;
      background: var(--grad-main);
      color: var(--text);
      line-height: 1.55;
    }
    #layout {
      display: flex;
      flex-direction: row;
      gap: 24px;
      max-width: 1280px;
      margin: auto;
      padding: 24px;
      height: 100%;
      box-sizing: border-box;
    }
    @media (max-width: 900px) {
      #layout {
        flex-direction: column;
      }
    }

    /* ---------- chat ---------- */
    #chat-col {
      flex: 3;
      display: flex;
      flex-direction: column;
      gap: 12px;
      padding: 24px;
      background: rgba(255, 255, 255, .6);
      border-radius: 24px;
      box-shadow: var(--shadow);
      border: 1px solid rgba(255, 255, 255, .4);
      box-sizing: border-box;
      height: 100%;
    }
    #chatbox {
      flex: 1;
      overflow-y: auto;
      padding: 8px;
      background: transparent;
    }
    .bubble {
      padding: 12px 18px;
      margin: 10px 0;
      border-radius: 18px;
      max-width: 88%;
      animation: fade .25s;
    }
    .bubble.bot {
      background: #fff;
      border: 1px solid rgba(0, 0, 0, .05);
    }
    .bubble.user {
      background: var(--grad-rose);
      color: #fff;
      margin-left: auto;
      border-bottom-right-radius: 6px;
    }
    @keyframes fade {
      from {
        opacity: 0;
        transform: translateY(6px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    .typing {
      display: inline-block;
      width: 32px;
      height: 8px;
    }
    .typing span {
      display: inline-block;
      width: 6px;
      height: 6px;
      margin: 0 2px;
      background: #888;
      border-radius: 50%;
      animation: blink 1.2s infinite;
    }
    .typing span:nth-child(2) {
      animation-delay: .2s;
    }
    .typing span:nth-child(3) {
      animation-delay: .4s;
    }
    @keyframes blink {
      0%, 80%, 100% {
        opacity: .2;
      }
      40% {
        opacity: 1;
      }
    }
    textarea {
      width: 100%;
      min-height: 90px;
      padding: 16px 20px;
      font-size: 16px;
      border-radius: 18px;
      border: 1px solid rgba(0, 0, 0, .15);
      box-sizing: border-box;
    }
    button#send {
      align-self: flex-end;
      margin-top: 6px;
      padding: 12px 24px;
      border: none;
      border-radius: 18px;
      background: var(--grad-rose);
      color: #fff;
      font-size: 16px;
      cursor: pointer;
    }

    /* ---------- chips ---------- */
    #choices {
      display: flex;
      flex-wrap: wrap;
      column-gap: 14px;
      row-gap: 12px;
    }
    .badge, .theme-chip, .topic-chip {
      padding: 8px 16px;
      border-radius: 9999px;
      font-size: 14px;
      cursor: pointer;
      user-select: none;
      transition: .25s;
    }
    .badge {
      background: var(--grad-rose);
      color: #fff;
    }
    .theme-chip {
      border: 1px solid var(--rose);
      color: var(--rose);
      background: #fff;
      position: relative;
      padding-right: 12px;
      margin: 4px;
    }
    .theme-chip:hover {
      background: var(--grad-rose);
      color: #fff;
    }
    .theme-chip.selected {
      background: linear-gradient(135deg, var(--sage), var(--sage-light));
      color: #fff;
      border: none;
      padding-right: 28px;
    }
    .edit-bar {
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 0.85rem;
      cursor: pointer;
      opacity: 0.8;
    }
    .edit-bar:hover {
      opacity: 1;
    }
    .topic-chip {
      position: relative;
      border: 1px solid var(--sage);
      color: var(--sage);
      background: rgba(140, 191, 157, .12);
      margin: 4px;
    }
    .topic-chip.selected {
      background: linear-gradient(135deg, var(--sage), var(--sage-light));
      color: #fff;
      border: 0;
    }
    .topic-chip[data-desc]:hover::after {
      content: attr(data-desc);
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      top: 110%;
      background: var(--rose-light);
      color: #fff;
      padding: 6px 10px;
      border-radius: 8px;
      white-space: nowrap;
      font-size: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, .15);
      z-index: 20;
    }
    .topic-chip[data-desc]:hover::before {
      content: "";
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      top: 100%;
      border: 6px solid transparent;
      border-top-color: var(--rose-light);
    }

    /* ---------- sidebar (front/back flip) ---------- */
    #sidebar-flip-container {
      flex: 2;
      display: flex;
      flex-direction: column;
      height: 100%;
    }
    .flip-container {
      width: 100%;
      height: 100%;
      perspective: 1000px;
      position: relative;
      display: flex;
      flex-direction: column;
      box-sizing: border-box;
    }
    .sidebar-face {
      width: 100%;
      height: 100%;
      backface-visibility: hidden;
      -webkit-backface-visibility: hidden;
      position: absolute;
      top: 0;
      left: 0;
      background: rgba(255, 255, 255, .6);
      border-radius: 24px;
      box-shadow: var(--shadow);
      border: 1px solid rgba(255, 255, 255, .4);
      padding: 24px;
      box-sizing: border-box;
      overflow-y: auto;
      transform-style: preserve-3d;
      transition: transform 0.6s ease;
      display: flex;
      flex-direction: column;
    }
    .sidebar-face.front {
      transform: rotateY(0deg);
      z-index: 2;
    }
    .sidebar-face.back {
      transform: rotateY(-180deg);
      z-index: 1;
    }
    .flip-container.flipped .front {
      transform: rotateY(180deg);
    }
    .flip-container.flipped .back {
      transform: rotateY(0deg);
      z-index: 2;
    }
    #q-title {
      margin-bottom: 6px;
      color: var(--text-light);
      font-weight: 600;
    }
    #q-options {
      display: flex;
      flex-wrap: wrap;
      column-gap: 14px;
      row-gap: 12px;
      margin-bottom: 12px;
    }
    #qa-log {
      flex: 1;
      overflow-y: auto;
      padding: 8px;
      margin-top: 8px;
    }

    /* Terug-knop bovenaan back-face */
    .back-button {
      background: none;
      border: none;
      font-size: 1rem;
      color: var(--rose);
      cursor: pointer;
      margin-bottom: 16px;
      align-self: flex-start;
    }

    /* Loader (simpele spinner + voortgangsbalk) */
    .loader-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-bottom: 16px;
    }
    .loader {
      width: 32px;
      height: 32px;
      border: 4px solid rgba(0, 0, 0, 0.1);
      border-top-color: var(--rose);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 8px;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .progress-bar {
      width: 100%;
      height: 8px;
      background: rgba(0, 0, 0, 0.05);
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 16px;
    }
    .progress-fill {
      height: 100%;
      width: 0%;
      background: var(--sage);
      transition: width 0.3s ease;
    }
    .confirm-button {
      width: 100%;
      padding: 12px 0;
      border: none;
      border-radius: 18px;
      background: var(--grad-rose);
      color: #fff;
      font-size: 16px;
      cursor: pointer;
      margin-top: 12px;
      align-self: stretch;
    }
    .confirm-button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
  </style>
</head>
<body>

<main id="layout">
  <!-- Chatkolom -->
  <div id="chat-col">
    <div id="chatbox"></div>
    <div id="choices"></div>
    <textarea id="input" placeholder="Typ je bericht…"></textarea>
    <button id="send">Verstuur</button>
  </div>

  <!-- Sidebar met omklap-container -->
  <div id="sidebar-flip-container">
    <div class="flip-container">
      <!-- Front-zijde: thema's & QA-log -->
      <aside class="sidebar-face front" id="sidebar-front">
        <h4 id="q-title"></h4>
        <div id="q-options"></div>
        <hr>
        <h5>Antwoorden</h5>
        <div id="qa-log"></div>
      </aside>

      <!-- Achterkant: onderwerpen + loader/progress -->
      <aside class="sidebar-face back" id="sidebar-back">
        <button id="back-to-themes" class="back-button">← Terug</button>
        <h4 id="back-title" style="margin-bottom:6px; color: var(--text-light); font-weight:600;"></h4>
        <div id="topic-loader" class="loader-container" style="display: none;">
          <div class="loader"></div>
          <div class="progress-bar">
            <div class="progress-fill" id="progress-fill"></div>
          </div>
        </div>
        <div id="q-topic-options" style="display: flex; flex-wrap: wrap; row-gap: 8px;"></div>
        <button id="confirm-topics" class="confirm-button" disabled>Bevestig onderwerpen →</button>
      </aside>
    </div>
  </div>
</main>

<script>
  /* ---------- mini TaskAgent ---------- */
  (() => {
    const done = new Set();
    window.TaskAgent = {
      start(o) {
        if (done.has(o.id)) return;
        const { title, description, labels, onYes, onNo, onOther } = o;
        const ov = document.createElement("div");
        Object.assign(ov.style, {
          position: "fixed",
          inset: 0,
          display: "flex",
          background: "rgba(0,0,0,.55)",
          alignItems: "center",
          justifyContent: "center",
          zIndex: 9999
        });
        const card = document.createElement("div");
        card.style.cssText =
          "background:#fff;padding:26px;border-radius:18px;max-width:440px;width:90%;text-align:center;font-family:inherit;box-shadow:0 8px 40px rgba(0,0,0,.15)";
        card.innerHTML = `<h2 style="font-size:1.25rem;margin:0 0 10px">${title}</h2><p style="font-size:.95rem;margin:0 0 18px">${description}</p>`;
        const wrap = document.createElement("div");
        wrap.style.display = "flex";
        wrap.style.gap = "10px";
        ["yes", "no", "other"].forEach((k) => {
          const b = document.createElement("button");
          b.textContent = labels[k];
          b.style.cssText =
            "flex:1 1 100px;padding:10px 0;border:none;border-radius:10px;background:#667eea;color:#fff;cursor:pointer";
          b.onclick = () => {
            ov.remove();
            ({ yes: onYes, no: onNo, other: onOther })[k]?.();
          };
          wrap.appendChild(b);
        });
        card.appendChild(wrap);
        ov.appendChild(card);
        document.body.appendChild(ov);
        done.add(o.id);
      }
    };
  })();

  const API = "https://chatbotbvmp.onrender.com/agent";
  let sessionId = sessionStorage.getItem("agentSession") || null;

  /* DOM-elementen */
  const chatbox = document.getElementById("chatbox");

  function addMsg(role, md) {
    const d = document.createElement("div");
    d.className = "bubble " + (role === "bot" ? "bot" : "user");
    d.innerHTML = marked.parse(md);
    chatbox.appendChild(d);
    chatbox.scrollTop = chatbox.scrollHeight;
    return d;
  }

  function typingBubble() {
    const b = addMsg("bot", "<span class='typing'><span></span><span></span><span></span></span>");
    return b;
  }

  async function callAgent(message) {
    const wait = typingBubble();
    const r = await fetch(API, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ message, session_id: sessionId })
    });
    chatbox.removeChild(wait);
    const data = await r.json();
    sessionId = data.session_id;
    sessionStorage.setItem("agentSession", sessionId);
    return data;
  }

  /* QA-log bijwerken */
  function logQA(qa) {
    const el = document.getElementById("qa-log");
    el.innerHTML = "";
    (qa || []).forEach((r) => {
      const p = document.createElement("p");
      p.innerHTML = `<strong>${r.theme}</strong><br><em>${r.question}</em><br>${r.answer}`;
      el.appendChild(p);
    });
    el.scrollTop = el.scrollHeight;
  }

  /* ─── Globals ─── */
  let currentTheme = null;
  let selectedTopics = [];
  window.uiTopicOptionsForTheme = [];

  /* Thema-chips renderen (front-side) */
  function renderThemes(opts) {
    const box = document.getElementById("q-options"),
      tit = document.getElementById("q-title");
    box.innerHTML = "";
    tit.textContent = "Kies een thema (max 6):";
    opts.forEach((o) => {
      const c = document.createElement("span");
      c.className = "theme-chip";
      c.textContent = o.name;
      c.onclick = () => {
        // Opdracht naar agent: register_theme
        handleChoice(`Thema geselecteerd: ${o.name}`);
        // Onthoud topic-opties (back-end vult eventueel later aan)
        window.uiTopicOptionsForTheme = o.options || [];
        // Flip de sidebar en laad onderwerpen
        onThemeClick(o.name);
      };
      box.appendChild(c);
    });
  }

  /* Flip naar back-face en laad onderwerpen */
  function onThemeClick(themeName) {
    currentTheme = themeName;
    document.getElementById("back-title").textContent = `Onderwerpen voor “${themeName}”`;
    document.getElementById("topic-loader").style.display = "flex";
    document.getElementById("q-topic-options").style.display = "none";
    document.getElementById("confirm-topics").disabled = true;
    document.querySelector(".flip-container").classList.add("flipped");

    // Simuleer voortgang: naar 80%
    setTimeout(() => {
      document.getElementById("progress-fill").style.width = "80%";
    }, 200);

    // Zodra de opties beschikbaar zijn, maak chips
    setTimeout(() => {
      renderTopicChips(window.uiTopicOptionsForTheme);
      document.getElementById("topic-loader").style.display = "none";
      document.getElementById("q-topic-options").style.display = "flex";
      selectedTopics = [];
      updateConfirmButtonState();
      document.getElementById("progress-fill").style.width = "100%";
    }, 600);
  }

  /* Topic-chips renderen (back-side) */
  function renderTopicChips(options) {
    const container = document.getElementById("q-topic-options");
    container.innerHTML = "";
    options.forEach((opt) => {
      const chip = document.createElement("span");
      chip.className = "topic-chip";
      chip.textContent = opt.name;
      chip.dataset.desc = opt.description || "";
      chip.onclick = () => {
        chip.classList.toggle("selected");
        if (chip.classList.contains("selected")) {
          if (selectedTopics.length < 4) {
            selectedTopics.push(opt.name);
          } else {
            chip.classList.remove("selected");
          }
        } else {
          selectedTopics = selectedTopics.filter((t) => t !== opt.name);
        }
        updateConfirmButtonState();
      };
      container.appendChild(chip);
    });
  }

  /* Bevestig-knop (back-side) activeren/deactiveren */
  function updateConfirmButtonState() {
    const btn = document.getElementById("confirm-topics");
    btn.disabled = selectedTopics.length === 0;
  }

  /* Terug-knop (back to themes) */
  document.getElementById("back-to-themes").onclick = () => {
    document.querySelector(".flip-container").classList.remove("flipped");
  };

  /* Bevestig onderwerpen: opslaan, flip terug, thema markeren */
  document.getElementById("confirm-topics").onclick = () => {
    selectedTopics.forEach((topicName) => {
      // Opdracht naar agent: register_topic
      handleChoice(`Onderwerp geselecteerd: ${topicName}`);
    });
    // Opdracht naar agent: complete_theme
    handleChoice(`Ik ben klaar met de onderwerpen voor ${currentTheme}.`);
    // Flip terug
    document.querySelector(".flip-container").classList.remove("flipped");
    // Markeer thema-chip en voeg edit-bar toe
    markThemeAsSelected(currentTheme);
  };

  /* Thema-chip markeren en bewerkbaar maken */
  function markThemeAsSelected(themeName) {
    const chips = document.querySelectorAll("#q-options .theme-chip");
    chips.forEach((chip) => {
      if (chip.textContent.trim() === themeName) {
        chip.classList.add("selected");
        if (!chip.querySelector(".edit-bar")) {
          const editBar = document.createElement("span");
          editBar.className = "edit-bar";
          editBar.textContent = "✎";
          editBar.onclick = (e) => {
            e.stopPropagation();
            onThemeClick(themeName);
          };
          chip.appendChild(editBar);
        }
      }
    });
  }

  /* callAndRender koppelt met back-end-stadia */
  async function callAndRender(msg) {
    const data = await callAgent(msg);
    if (data.assistant_reply) addMsg("bot", data.assistant_reply);

    // Kies thema-fase
    if (data.stage === "choose_theme" && data.options) {
      renderThemes(data.options);
    }

    // Kies topic-fase: back-end levert data.options
    if (data.stage === "choose_topic" && data.options && data.current_theme) {
      window.uiTopicOptionsForTheme = data.options;
      onThemeClick(data.current_theme);
    }

    // Na complete_theme keert terug naar choose_theme
    if (data.stage === "choose_theme" && data.options) {
      renderThemes(data.options);
    }

    logQA(data.qa || []);
  }

  /* Gebruikersinvoer afhandelen */
  async function handleChoice(txt, showBubble = true) {
    if (!txt) return;
    const inp = document.getElementById("input");
    if (showBubble) addMsg("user", txt);
    inp.value = "";
    try {
      await callAndRender(txt);
    } catch {
      addMsg("bot", "⚠️ Fout.");
    }
  }

  document.getElementById("send").onclick = () =>
    handleChoice(document.getElementById("input").value.trim());
  document.getElementById("input").addEventListener("keydown", (e) => {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      document.getElementById("send").click();
    }
  });

  /* Welkomstbericht & TaskAgent-popup */
  addMsg("bot", "Welkom bij <strong>Beval met een Plan</strong>! Ik help je stap-voor-stap bij jouw geboorte­plan.");
  setTimeout(() =>
    TaskAgent.start({
      id: "start1",
      title: "Aan de slag",
      description: "Zullen we samen eerst de thema’s kiezen die jij belangrijk vindt?",
      labels: { yes: "Ja!", no: "Later", other: "Anders" },
      onYes: () => handleChoice("Ik ben klaar om thema’s te kiezen."),
      onNo: () => addMsg("bot", "Geen probleem – typ ‘begin’ als je wilt starten."),
      onOther: () => addMsg("bot", "Vertel wat je nu nodig hebt."),
    }),
    3000
  );
</script>
</body>
</html>
