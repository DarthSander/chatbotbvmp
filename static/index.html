<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Geboorteplan-agent</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <style>
    /* ---------- Kleurenpalet & basis stijl ---------- */
    :root {
      --rose: #d5848d; --rose-light: #e8a8b0; --sage: #8cbf9d;
      --sage-light: #cfe6d0; --cream: #fef9f5; --beige: #fdf7f2;
      --rose-sub: #fbeaec; --text: #2d3436; --text-light: #636e72;
      --grad-main: linear-gradient(135deg, var(--cream), var(--beige) 50%, var(--rose-sub) 100%);
      --shadow: 0 6px 22px rgba(0, 0, 0, .1);
    }
    html, body {
      height: 100%; margin: 0; padding: 0; font-family: Inter, system-ui, sans-serif;
      background: var(--grad-main); color: var(--text); line-height: 1.55;
    }
    /* Layout */
    #layout { display: flex; gap: 24px; height: 100%; padding: 16px; box-sizing: border-box; }
    #chat-col { flex: 2; display: flex; flex-direction: column; max-height: 100%; }
    #sidebar-container { flex: 1; perspective: 1500px; }
    /* Chat */
    #chatbox, #mobile-chatbox { flex: 1; overflow-y: auto; padding-right: 8px; }
    .bubble { padding: 12px 16px; margin: 8px 0; border-radius: 12px; max-width: 80%; line-height: 1.4; word-wrap: break-word; box-shadow: var(--shadow); }
    .bubble.user { background: #fff; margin-left: auto; }
    .bubble.bot { background: var(--rose-sub); margin-right: auto; }
    #quick-replies { padding: 8px 0; display: flex; flex-wrap: wrap; gap: 8px; justify-content: flex-start; }
    #quick-replies .chip { margin: 0; }
    #input-area, #mobile-input-area { display: flex; flex-direction: column; }
    #input-wrapper, #mobile-input-wrapper { display: flex; gap: 8px; margin-top: auto; border-top: 1px solid #ddd; padding: 8px 0; }
    #input, #mobile-input { flex: 1; border: none; padding: 10px; font-size: 16px; border-radius: 4px; font-family: inherit; }
    #input:focus, #mobile-input:focus { outline: 2px solid var(--rose); }
    #send, #mobile-send { background: var(--rose); color: #fff; border: none; padding: 0 16px; font-size: 16px; border-radius: 4px; cursor: pointer; }
    #send:hover, #mobile-send:hover { background: var(--rose-light); }
    /* Flip Container & Sidebar Faces */
    #flip-card { width: 100%; height: 100%; position: relative; transform-style: preserve-3d; transition: transform 0.7s; }
    #flip-card.is-flipped { transform: rotateY(180deg); }
    .sidebar-face {
      position: absolute; width: 100%; height: 100%; backface-visibility: hidden;
      background: white; border-radius: 16px; padding: 20px;
      box-shadow: var(--shadow); overflow-y: auto; box-sizing: border-box;
    }
    .face-front { /* Toont thema's en QA */ }
    .face-back { transform: rotateY(180deg); /* Toont onderwerpen */ }
    /* Plan-weergave & Chips */
    .plan-section h5 { margin: 16px 0 8px; border-bottom: 1px solid #eee; padding-bottom: 4px; }
    .chips-container { display: flex; flex-wrap: wrap; gap: 8px; }
    .chip { padding: 6px 14px; border-radius: 9999px; font-size: 14px; cursor: pointer; user-select: none; border: 1px solid #ddd; }
    .chip.theme { border-color: var(--rose); color: var(--rose); }
    .chip.topic { border-color: var(--sage); color: var(--sage); }
    .chip.selected { color: white; border-color: transparent; }
    .chip.theme.selected { background: var(--rose); }
    .chip.topic.selected { background: var(--sage); }
    .chip.disabled { opacity: 0.5; cursor: not-allowed; }
    .qa-item { margin-bottom: 12px; }
    .qa-item strong { display: block; }
    .back-button { background: none; border: none; font-size: 16px; cursor: pointer; color: var(--rose); margin-bottom: 12px; }
    .confirm-btn { background: var(--sage); color: white; border: none; padding: 10px 16px; border-radius: 8px; cursor: pointer; font-size: 15px; margin-top: 16px; width: 100%; }
    .confirm-btn:disabled { background: #ccc; cursor: not-allowed; }
    /* Loader */
    .loader-container { display: none; align-items: center; justify-content: center; margin: 20px; }
    .loader { width: 32px; height: 32px; border: 4px solid #ccc; border-top-color: var(--sage); border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    /* Mobiel */
    #mobile-tabs { display: none; }
    .mobile-face { display: none; height: calc(100vh - 50px); overflow-y: auto; padding: 16px; box-sizing: border-box; background: #fff; }
    .mobile-face.active { display: block; }
    #mobile-chat-face { display: flex; flex-direction: column; height: 100%; }
    @media (max-width: 900px) {
      #layout { flex-direction: column; padding: 0 !important; }
      #chat-col, #sidebar-container { display: none !important; }
      #mobile-tabs { display: flex; border-bottom: 1px solid #ddd; }
      #mobile-tabs button { flex: 1; padding: 12px; background: #f9f9f9; border: none; font-size: 16px; cursor: pointer; }
      #mobile-tabs button.active { background: #fff; font-weight: 600; }
    }
  </style>
</head>
<body>
  <!-- Mobiele tabknoppen -->
  <div id="mobile-tabs">
    <button id="tab-chat" class="active">Chat</button>
    <button id="tab-plan">Jouw Plan</button>
  </div>

  <main id="layout">
    <!-- Chat kolom -->
    <div id="chat-col">
      <div id="chatbox"></div>
      <div id="input-area">
        <div id="quick-replies" class="chips-container"></div>
        <div class="loader-container" id="chat-loader"><div class="loader"></div></div>
        <div id="input-wrapper">
          <textarea id="input" placeholder="Typ je bericht…" rows="1"></textarea>
          <button id="send">Verstuur</button>
        </div>
      </div>
    </div>

    <!-- Sidebar met Flip-animatie -->
    <div id="sidebar-container">
        <div id="flip-card">
            <div class="sidebar-face face-front" id="plan-front"></div>
            <div class="sidebar-face face-back" id="plan-back"></div>
        </div>
    </div>

    <!-- Mobiele weergave container -->
    <div id="mobile-container" style="display:none;">
      <div class="mobile-face active" id="mobile-chat-face">
        <div id="mobile-chatbox"></div>
        <div id="mobile-input-area">
          <div id="mobile-quick-replies" class="chips-container"></div>
          <div class="loader-container" id="mobile-chat-loader"><div class="loader"></div></div>
          <div id="mobile-input-wrapper">
            <textarea id="mobile-input" placeholder="Typ je bericht…" rows="1"></textarea>
            <button id="mobile-send">Verstuur</button>
          </div>
        </div>
      </div>
      <div class="mobile-face" id="mobile-plan-face">
        <!-- Inhoud wordt dynamisch gevuld -->
      </div>
    </div>
  </main>
<script>
window.addEventListener('DOMContentLoaded', () => {
  console.log('[Init] DOM volledig geladen. Script wordt uitgevoerd.');

  /* ───── 1. Globals & DOM ─────────────────────────────────── */
  const API_URL = "/agent";
  let sessionId = sessionStorage.getItem("agentSession") || null;
  let localSelections = { themes: new Set(), topics: {} };
  let currentThemeForTopics = null;
  console.log(`[Init] Sessie ID bij start: ${sessionId}`);

  const ui = {
    chatbox: document.getElementById("chatbox"), mobileChatbox: document.getElementById("mobile-chatbox"),
    quickReplies: document.getElementById("quick-replies"), mobileQuickReplies: document.getElementById("mobile-quick-replies"),
    input: document.getElementById("input"), mobileInput: document.getElementById("mobile-input"),
    sendBtn: document.getElementById("send"), mobileSendBtn: document.getElementById("mobile-send"),
    chatLoader: document.getElementById("chat-loader"), mobileChatLoader: document.getElementById("mobile-chat-loader"),
    planFront: document.getElementById("plan-front"), planBack: document.getElementById("plan-back"),
    mobilePlanFace: document.getElementById("mobile-plan-face"),
    flipCard: document.getElementById("flip-card"),
    sidebarContainer: document.getElementById("sidebar-container"), chatCol: document.getElementById("chat-col"),
    mobileContainer: document.getElementById("mobile-container"), mobileTabs: document.getElementById("mobile-tabs"),
  };

  /* ───── 2. Helpers ──────────────────────────────────────── */
  const addMsg = (role, md, box) => {
    const bubble = document.createElement("div");
    bubble.className = `bubble ${role === "bot" ? "bot" : "user"}`;
    bubble.innerHTML = marked.parse(md);
    box.appendChild(bubble);
    box.scrollTop = box.scrollHeight;
  };
  const showLoader = (isMobile) => { (isMobile ? ui.mobileChatLoader : ui.chatLoader).style.display = "flex"; };
  const hideLoader = (isMobile) => { (isMobile ? ui.mobileChatLoader : ui.chatLoader).style.display = "none"; };

  /* ───── 3. Server Call ──────────────────────────────────── */
  async function callAgent(message, sid) {
    const isMobile = window.innerWidth <= 900;
    const chatBox = isMobile ? ui.mobileChatbox : ui.chatbox;
    const payload = { message, session_id: sid };
    console.log('[API Call] Verzenden naar agent:', payload);
    showLoader(isMobile);
    try {
      const res = await fetch(API_URL, {
        method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(payload)
      });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const data = await res.json();
      console.log('[API Response] Data ontvangen van agent:', data);
      return data;
    } catch (err) {
      console.error("[API Error]", err);
      addMsg("bot", "⚠️ Er ging iets mis. Probeer het later opnieuw.", chatBox);
      throw err;
    } finally {
      hideLoader(isMobile);
    }
  }

  /* ───── 4. UI Rendering Engine ──────────────────────────── */
  function renderUI(data) {
    console.log('[UI Render] Start UI-render met data:', data);
    if (!data || !data.plan) {
        console.warn('[UI Render] Geen of ongeldige data om te renderen.');
        return;
    }
    
    localSelections.themes = new Set((data.plan.themes || []).map(t => t.name));
    localSelections.topics = data.plan.topics || {};
    console.log('[UI Render] Lokale selecties gesynchroniseerd:', localSelections);

    renderFrontFace(data.plan);
    renderBackFace();
    renderMobilePlan();
    renderQuickReplies(data.suggested_replies || []);
  }

  function renderFrontFace(plan) {
    let html = '<h4>Jouw Geboorteplan</h4>';
    html += '<div class="plan-section"><h5>Thema\'s (kies max 6)</h5><div class="chips-container">';
    const allPossibleThemes = Array.from(new Set([...DEFAULT_THEME_LIST, ...Array.from(localSelections.themes)]));
    
    allPossibleThemes.forEach(themeName => {
      const isSelected = localSelections.themes.has(themeName);
      const isDisabled = !isSelected && localSelections.themes.size >= 6;
      html += `<div class="chip theme ${isSelected ? 'selected' : ''} ${isDisabled ? 'disabled' : ''}" onclick="handleThemeChipClick('${themeName}')">${themeName}</div>`;
    });
    html += '</div><button class="confirm-btn" onclick="confirmThemeSelections()">Bevestig Thema\'s</button></div>';
    
    html += '<div class="plan-section"><h5>Jouw Antwoorden</h5>';
    if (plan.qa_items && plan.qa_items.length > 0) {
      plan.qa_items.forEach(qa => {
        html += `<div class="qa-item"><strong>${qa.question}</strong><em>${qa.answer || 'Nog geen antwoord'}</em></div>`;
      });
    } else {
      html += '<p style="font-style: italic; color: #666;">Nog geen vragen beantwoord.</p>';
    }
    html += '</div>';
    ui.planFront.innerHTML = html;
  }

  function renderBackFace() {
    if (!currentThemeForTopics) {
        ui.planBack.innerHTML = '';
        return;
    }
    
    let html = `<button class="back-button" onclick="flipToFront()">← Terug naar overzicht</button>`;
    html += `<h4>Onderwerpen voor "${currentThemeForTopics}"</h4>`;
    html += '<div class="chips-container">';
    
    const selectedTopics = new Set(localSelections.topics[currentThemeForTopics] || []);
    const allPossibleTopics = Array.from(new Set([...(DEFAULT_TOPICS_PER_THEME[currentThemeForTopics] || []), ...Array.from(selectedTopics)]));

    if(allPossibleTopics.length === 0){
        html += `<p style="font-style: italic; color: #666;">Vraag de agent om suggesties voor dit thema.</p>`;
    } else {
        allPossibleTopics.forEach(topicName => {
            const isSelected = selectedTopics.has(topicName);
            const isDisabled = !isSelected && selectedTopics.size >= 4;
            html += `<div class="chip topic ${isSelected ? 'selected' : ''} ${isDisabled ? 'disabled' : ''}" onclick="handleTopicChipClick('${currentThemeForTopics}', '${topicName}')">${topicName}</div>`;
        });
    }
    html += `</div><button class="confirm-btn" onclick="confirmTopicSelections('${currentThemeForTopics}')">Bevestig Onderwerpen</button>`;
    ui.planBack.innerHTML = html;
  }
  
  function renderMobilePlan(){
      const frontFaceHtml = ui.planFront.innerHTML;
      ui.mobilePlanFace.innerHTML = frontFaceHtml;
  }
  
  function renderQuickReplies(replies) {
    const isMobile = window.innerWidth <= 900;
    const container = isMobile ? ui.mobileQuickReplies : ui.quickReplies;
    container.innerHTML = '';
    if (!replies || replies.length === 0) return;

    console.log('[UI Render] Quick replies renderen:', replies);
    replies.forEach(reply => {
        const button = document.createElement('button');
        button.className = 'chip';
        button.textContent = reply;
        button.onclick = () => {
            handleSend(reply);
        };
        container.appendChild(button);
    });
  }

  /* ───── 5. Hoofdlogica & UI Interactie ─────────────────── */
  async function handleSend(txt, isSilent = false) {
    if (!txt.trim()) return;
    const isMobile = window.innerWidth <= 900;
    const chatBox = isMobile ? ui.mobileChatbox : ui.chatbox;
    const inputEl = isMobile ? ui.mobileInput : ui.input;
    
    if (!isSilent) {
        console.log(`[handleSend] Zichtbaar bericht wordt verstuurd: "${txt}"`);
        addMsg("user", txt, chatBox);
    } else {
        console.log(`[handleSend] Stil bericht wordt verstuurd: "${txt}"`);
    }

    inputEl.value = "";
    renderQuickReplies([]);

    const data = await callAgent(txt, sessionId);
    
    if (data) {
      sessionId = data.session_id;
      sessionStorage.setItem("agentSession", sessionId);
      if (data.assistant_reply) addMsg("bot", data.assistant_reply, chatBox);
      renderUI(data);
    }
  }

  window.handleThemeChipClick = (themeName) => {
    console.log(`[Chip Click] Thema geklikt: ${themeName}`);
    currentThemeForTopics = themeName;
    
    // Alleen lokaal de UI bijwerken om de flip te triggeren.
    // De 'echte' selectie gebeurt bij bevestiging.
    if (!localSelections.themes.has(themeName)) {
       if (localSelections.themes.size >= 6) {
           console.log(`[Chip Click] Limiet bereikt, kan niet selecteren.`);
           return;
       }
       // We tonen het alsof het geselecteerd is, maar sturen het pas later.
    }
    
    // Forceer een rerender van de achterkant.
    renderBackFace(); 
    
    setTimeout(() => ui.flipCard.classList.add('is-flipped'), 50);
  }

  window.handleTopicChipClick = (themeName, topicName) => {
      console.log(`[Chip Click] Onderwerp geklikt: ${topicName} voor thema ${themeName}`);
      // Lokaal de selectie togglen in de UI, zonder direct te versturen.
      const selectedTopics = new Set(localSelections.topics[themeName] || []);
      if (selectedTopics.has(topicName)) {
          selectedTopics.delete(topicName);
      } else if (selectedTopics.size < 4) {
          selectedTopics.add(topicName);
      }
      localSelections.topics[themeName] = Array.from(selectedTopics);
      console.log(`[Chip Click] Lokale onderwerpen voor ${themeName} bijgewerkt:`, localSelections.topics[themeName]);
      renderBackFace(); // Alleen de achterkant opnieuw tekenen
  }
  
  window.flipToFront = () => {
      console.log('[UI Action] Terugflippen naar voorkant.');
      ui.flipCard.classList.remove('is-flipped');
  }

  window.confirmThemeSelections = () => {
      const themeNames = Array.from(localSelections.themes);
      const message = `Ik heb mijn thema's gekozen. Dit zijn ze: ${themeNames.join(', ')}.`;
      handleSend(message, true); // Stuur stil
  }

  window.confirmTopicSelections = (themeName) => {
      const topicNames = localSelections.topics[themeName] || [];
      const message = `Voor het thema '${themeName}' heb ik de volgende onderwerpen gekozen: ${topicNames.join(', ')}.`;
      handleSend(message, true); // Stuur stil
      flipToFront();
  }
  
  const DEFAULT_THEME_LIST = ["Ondersteuning", "Bevalling & medisch beleid", "Sfeer en omgeving", "Voeding na de geboorte", "Kraamtijd", "Communicatie", "Speciale wensen", "Fotografie en video", "Comfortmaatregelen", "Partnerbetrokkenheid"];
  const DEFAULT_TOPICS_PER_THEME = {
    "Ondersteuning": ["Aanwezigheid partner", "Rol van de partner", "Aanwezigheid doula", "Communicatie met zorgverleners"],
    "Bevalling & medisch beleid": ["Pijnbestrijding opties", "Houding tijdens bevallen", "Medische interventies", "Keizersnede voorkeuren"],
    "Sfeer en omgeving": ["Muziek en geluid", "Licht en temperatuur", "Gebruik van water (douche/bad)", "Privacy wensen"],
    "Voeding na de geboorte": ["Borstvoeding of flesvoeding", "Voedingshoudingen", "Kolven", "Hulp bij voeding"],
  };

  /* ───── 6. Initialisatie ────────────────────────────────── */
  const setupEventListeners = () => {
    ui.sendBtn.onclick = () => handleSend(ui.input.value);
    ui.mobileSendBtn.onclick = () => handleSend(ui.mobileInput.value);
    const handleKeydown = (e) => { if (e.key === "Enter" && !e.shiftKey) { e.preventDefault(); handleSend(e.target.value); }};
    ui.input.addEventListener("keydown", handleKeydown);
    ui.mobileInput.addEventListener("keydown", handleKeydown);
    document.getElementById("tab-chat").onclick = () => switchMobileFace("chat");
    document.getElementById("tab-plan").onclick = () => switchMobileFace("plan");
  };

  function switchMobileFace(faceName) {
      console.log(`[Mobile] Wisselen naar tab: ${faceName}`);
      document.getElementById("mobile-chat-face").classList.toggle('active', faceName === 'chat');
      document.getElementById("mobile-plan-face").classList.toggle('active', faceName === 'plan');
      document.getElementById("tab-chat").classList.toggle('active', faceName === 'chat');
      document.getElementById("tab-plan").classList.toggle('active', faceName === 'plan');
  }

  function updateLayoutForDevice() {
    const isMobile = window.innerWidth <= 900;
    console.log(`[Layout] Layout bijgewerkt. Is mobiel: ${isMobile}`);
    ui.chatCol.style.display = isMobile ? "none" : "flex";
    ui.sidebarContainer.style.display = isMobile ? "none" : "flex";
    ui.mobileContainer.style.display = isMobile ? "block" : "none";
    ui.mobileTabs.style.display = isMobile ? "flex" : "none";
  }

  updateLayoutForDevice();
  window.addEventListener("resize", updateLayoutForDevice);
  setupEventListeners();

  if (!sessionId) {
    handleSend("Hallo, ik wil graag een geboorteplan opstellen.");
  } else {
    handleSend("Hallo, ik ben terug. Kun je me laten zien waar we gebleven waren?");
  }
});
</script>
</body>
</html>

