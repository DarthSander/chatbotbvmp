<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Geboorteplan-agent</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

  <style>
    /* ============================================================ */
    /* =========== 1. DESKTOP STIJLING (ongewijzigd) ============== */
    /* ============================================================ */

    :root {
      --rose: #d5848d;
      --rose-light: #e8a8b0;
      --sage: #8cbf9d;
      --sage-light: #cfe6d0;
      --cream: #fef9f5;
      --beige: #fdf7f2;
      --rose-sub: #fbeaec;
      --text: #2d3436;
      --text-light: #636e72;
      --grad-main: linear-gradient(135deg, var(--cream), var(--beige) 50%, var(--rose-sub) 100%);
      --grad-rose: linear-gradient(135deg, var(--rose), var(--rose-light));
      --shadow: 0 6px 22px rgba(0, 0, 0, .1);
    }
    html, body {
      height: 100%; margin: 0; padding: 0;
      font-family: Inter, system-ui, sans-serif;
      background: var(--grad-main);
      color: var(--text);
      line-height: 1.55;
    }

    /* --- Desktop layout --- */
    #layout {
      display: flex;
      gap: 24px;
      max-width: 1280px;
      margin: auto;
      padding: 24px;
      height: 100%;
      box-sizing: border-box;
    }

    /* --- Chat column --- */
    #chat-col {
      flex: 3;
      display: flex;
      flex-direction: column;
      gap: 12px;
      padding: 24px;
      background: rgba(255,255,255,.6);
      border-radius: 24px;
      box-shadow: var(--shadow);
      border:1px solid rgba(255,255,255,.4);
      box-sizing:border-box;
      height:100%;
    }
    #chatbox { flex:1; overflow-y:auto; padding:8px; }
    .bubble {
      padding:12px 18px; margin:10px 0; border-radius:18px;
      max-width:88%; animation:fade .25s;
    }
    .bubble.bot { background:#fff; border:1px solid rgba(0,0,0,.05); }
    .bubble.user {
      background:var(--grad-rose); color:#fff;
      margin-left:auto; border-bottom-right-radius:6px;
    }
    @keyframes fade { from{opacity:0;transform:translateY(6px);} to{opacity:1;transform:translateY(0);} }
    .typing {
      display:inline-block; width:32px; height:8px;
    }
    .typing span {
      display:inline-block; width:6px; height:6px; margin:0 2px;
      background:#888; border-radius:50%; animation:blink 1.2s infinite;
    }
    .typing span:nth-child(2){ animation-delay:.2s; }
    .typing span:nth-child(3){ animation-delay:.4s; }
    @keyframes blink {0%,80%,100%{opacity:.2;}40%{opacity:1;}}

    textarea {
      width:100%; min-height:90px;
      padding:16px 20px; font-size:16px;
      border-radius:18px; border:1px solid rgba(0,0,0,.15);
      box-sizing:border-box;
    }
    button#send {
      align-self:flex-end; margin-top:6px;
      padding:12px 24px; border:none; border-radius:18px;
      background:var(--grad-rose); color:#fff;
      font-size:16px; cursor:pointer;
    }

    /* --- Sidebar (3 panels) --- */
    #sidebar-flip-container {
      flex:2; position:relative; height:100%;
    }
    .flip-container {
      width:100%; height:100%;
      perspective:1000px; transform-style:preserve-3d;
      transition:transform .6s ease; position:relative;
    }
    .flip-container.show-back  { transform:rotateY(-180deg); }
    .flip-container.show-third { transform:rotateY(-360deg); }

    .sidebar-face {
      position:absolute; top:0; left:0;
      width:100%; height:100%;
      backface-visibility:hidden; -webkit-backface-visibility:hidden;
      background:rgba(255,255,255,.6);
      border-radius:24px; box-shadow:var(--shadow);
      border:1px solid rgba(255,255,255,.4);
      padding:24px; box-sizing:border-box;
      display:flex; flex-direction:column; overflow-y:auto;
    }
    .sidebar-face.front { transform:rotateY(0deg);    z-index:3; }
    .sidebar-face.back  { transform:rotateY(-180deg); z-index:2; }
    .sidebar-face.third { transform:rotateY(-360deg); z-index:1; }

    .back-button {
      background:none; border:none; color:var(--rose);
      font-size:1rem; cursor:pointer; margin-bottom:16px;
      align-self:flex-start;
    }

    /* Loader-overlay */
    #sidebar-loader {
      position:absolute; top:0; left:0;
      width:100%; height:100%;
      background:rgba(255,255,255,0.8);
      display:flex; align-items:center; justify-content:center;
      z-index:4;
    }
    #sidebar-loader .spinner {
      border:4px solid rgba(0,0,0,0.1);
      border-top-color:var(--rose);
      border-radius:50%; width:32px; height:32px;
      animation:spin 1s linear infinite;
    }
    @keyframes spin{ to{transform:rotate(360deg);} }

    /* Thema & topics */
    #q-title { margin-bottom:6px; color:var(--text-light); font-weight:600; }
    #q-options { display:flex; flex-wrap:wrap; gap:12px 14px; margin-bottom:12px; }
    .theme-chip, .topic-chip {
      padding:8px 16px; border-radius:9999px;
      font-size:14px; cursor:pointer; user-select:none;
      transition:.25s; min-height:44px;
    }
    .theme-chip {
      border:1px solid var(--rose); color:var(--rose); background:#fff;
    }
    .theme-chip:hover { background:var(--grad-rose); color:#fff; }
    .theme-chip.selected {
      background:linear-gradient(135deg,var(--sage),var(--sage-light));
      color:#fff; border:none; padding-right:28px;
    }
    .edit-bar {
      position:absolute; right:8px; top:50%; transform:translateY(-50%);
      font-size:.85rem; cursor:pointer; opacity:.8;
    }
    .edit-bar:hover { opacity:1; }

    .topic-chip {
      border:1px solid var(--sage); color:var(--sage);
      background:rgba(140,191,157,.12);
    }
    .topic-chip.selected {
      background:linear-gradient(135deg,var(--sage),var(--sage-light));
      color:#fff; border:0;
    }
    .topic-chip[data-desc]:hover::after {
      content:attr(data-desc);
      position:absolute; left:50%; transform:translateX(-50%);
      top:110%; background:var(--rose-light);
      color:#fff; padding:6px 10px; border-radius:8px;
      white-space:nowrap; font-size:12px;
      box-shadow:0 4px 12px rgba(0,0,0,.15); z-index:20;
    }
    .topic-chip[data-desc]:hover::before {
      content:""; position:absolute; left:50%; transform:translateX(-50%);
      top:100%; border:6px solid transparent;
      border-top-color:var(--rose-light);
    }
    #q-topic-options { display:flex; flex-wrap:wrap; gap:8px; }

    .confirm-button {
      margin-top:auto; width:100%; padding:12px 0;
      border:none; border-radius:18px;
      background:var(--grad-rose); color:#fff;
      font-size:16px; cursor:pointer;
    }
    .confirm-button:disabled { opacity:.5; cursor:not-allowed; }

    /* Q&A paneel */
    #sidebar-third h5 { margin-top:0; font-size:1rem; font-weight:600; }
    #q-and-a { flex:1; overflow-y:auto; padding:8px; }
    .qa-item { margin-bottom:16px; }
    .qa-item .label    { font-size:.85rem; color:var(--text-light); margin-bottom:4px; }
    .qa-item .question { font-weight:600; margin-bottom:2px; }
    .qa-item .answer   { margin-left:8px; }

    /* ============================================================ */
    /* =========== 2. MOBIELE AANPASSINGEN  ======================= */
    /* ============================================================ */

    /* Verstop desktop, toon mobile flip */
    #mobile-flip { display:none; }
    #mobile-tabs { display:none; }

    .face {
      position:absolute; top:0; left:0;
      width:100%; height:100%;
      backface-visibility:hidden; -webkit-backface-visibility:hidden;
      padding:24px; box-sizing:border-box; overflow-y:auto;
      background:rgba(255,255,255,.6);
      border-radius:24px; box-shadow:var(--shadow);
      border:1px solid rgba(255,255,255,.4);
    }
    .chat-face  { transform:rotateY(  0deg); z-index:4; }
    .theme-face { transform:rotateY(-90deg); z-index:3; }
    .topic-face { transform:rotateY(-180deg); z-index:2; }
    .qa-face    { transform:rotateY(-270deg); z-index:1; }

    #mobile-flip {
      position:relative; width:100%; height:100%;
      transform-style:preserve-3d; transition:transform .6s ease;
    }
    #mobile-flip.show-chat   { transform:rotateY(   0deg); }
    #mobile-flip.show-themes { transform:rotateY( -90deg); }
    #mobile-flip.show-topics { transform:rotateY(-180deg); }
    #mobile-flip.show-qa     { transform:rotateY(-270deg); }

    /* Tabs onderin */
    @media(max-width:600px){
      /* hide desktop */
      #layout { display:none; }
      /* show mobile */
      #mobile-flip { display:block; }
      #mobile-tabs {
        display:flex;
        position:fixed; bottom:0; left:0; right:0;
        height:48px; background:#fff;
        box-shadow:0 -2px 8px rgba(0,0,0,.1);
        z-index:10;
      }
      #mobile-tabs button {
        flex:1; border:none; background:none;
        font-size:1rem; cursor:pointer;
      }
      #mobile-tabs button.new-qa {
        background:var(--rose-light); color:#fff;
      }
    }
  </style>
</head>
<body>

  <!-- DESKTOP -->
  <main id="layout">
    <!-- chat -->
    <div id="chat-col">
      <div id="chatbox"></div>
      <div id="choices"></div>
      <textarea id="input" placeholder="Typ je bericht…"></textarea>
      <button id="send">Verstuur</button>
    </div>
    <!-- sidebar -->
    <div id="sidebar-flip-container">
      <div id="sidebar-loader" style="display:none;"><div class="spinner"></div></div>
      <div class="flip-container">
        <aside class="sidebar-face front" id="sidebar-front">
          <h4 id="q-title"></h4>
          <div id="q-options"></div>
          <hr>
          <h5>Antwoorden</h5>
          <div id="qa-log"></div>
        </aside>
        <aside class="sidebar-face back" id="sidebar-back">
          <button id="back-to-themes" class="back-button">← Thema’s</button>
          <h4 id="back-title"></h4>
          <div id="q-topic-options"></div>
          <button id="confirm-topics" class="confirm-button" disabled>Bevestig onderwerpen →</button>
        </aside>
        <aside class="sidebar-face third" id="sidebar-third">
          <button id="back-to-topics" class="back-button">← Onderwerpen</button>
          <h5>Vragen & Antwoorden</h5>
          <div id="q-and-a"></div>
        </aside>
      </div>
    </div>
  </main>

  <!-- MOBILE flip -->
  <div id="mobile-flip" class="show-chat">
    <div class="face chat-face">
      <div id="chatbox-mobile"></div>
      <div id="choices-mobile"></div>
      <textarea id="input-mobile" placeholder="Typ je bericht…"></textarea>
      <button id="send-mobile">Verstuur</button>
    </div>
    <div class="face theme-face">
      <h4 id="q-title-mobile"></h4>
      <div id="q-options-mobile"></div>
    </div>
    <div class="face topic-face">
      <button id="back-to-themes-mobile" class="back-button">← Thema’s</button>
      <h4 id="back-title-mobile"></h4>
      <div id="q-topic-options-mobile"></div>
      <button id="confirm-topics-mobile" class="confirm-button" disabled>Bevestig onderwerpen →</button>
    </div>
    <div class="face qa-face">
      <button id="back-to-topics-mobile" class="back-button">← Onderwerpen</button>
      <h5>Vragen & Antwoorden</h5>
      <div id="q-and-a-mobile"></div>
    </div>
  </div>

  <!-- MOBIEL TABS -->
  <nav id="mobile-tabs">
    <button data-view="chat">Chat</button>
    <button data-view="themes">Thema’s</button>
    <button data-view="topics">Onderwerpen</button>
    <button data-view="qa" id="qa-tab">Q&A</button>
  </nav>

  <script>
    console.log('[init] frontend initialiseren');

    // ** KOPIEER CHAT & CHOICES NAAR MOBILE ** 
    // we plakken eenvoudig de bestaande elementen over
    document.getElementById('chatbox-mobile').replaceWith(document.getElementById('chatbox'));
    document.getElementById('choices-mobile').replaceWith(document.getElementById('choices'));
    document.getElementById('input-mobile').replaceWith(document.getElementById('input'));
    document.getElementById('send-mobile').replaceWith(document.getElementById('send'));

    const API = "https://chatbotbvmp.onrender.com/agent";
    let sessionId = sessionStorage.getItem("agentSession") || null;
    let currentTheme = null, selectedTopics = [];
    window.uiTopicOptionsForTheme = [];

    /* MESSAGE PRODUCERS */
    function addMsg(role, md) {
      console.log(`[addMsg] role=${role}`, md);
      const box = window.innerWidth<=600 ? document.getElementById('chatbox-mobile') : document.getElementById('chatbox');
      const d = document.createElement("div");
      d.className = "bubble " + (role==="bot"?"bot":"user");
      d.innerHTML = marked.parse(md);
      box.appendChild(d);
      box.scrollTop = box.scrollHeight;
      return d;
    }
    function typingBubble(){
      console.log('[typingBubble]');
      return addMsg("bot","<span class='typing'><span></span><span></span><span></span></span>");
    }

    /* API CALL */
    async function callAgent(message){
      console.log('[callAgent] ',message,sessionId);
      const wait = typingBubble();
      let data;
      try{
        const res = await fetch(API,{
          method:"POST",
          headers:{"Content-Type":"application/json"},
          body:JSON.stringify({message,session_id:sessionId})
        });
        const box = window.innerWidth<=600 ? document.getElementById('chatbox-mobile') : document.getElementById('chatbox');
        box.removeChild(wait);
        data = await res.json();
        console.log('[callAgent] resp',data);
        sessionId = data.session_id;
        sessionStorage.setItem("agentSession",sessionId);
      }catch(err){
        console.error('[callAgent] error',err);
        const box = window.innerWidth<=600 ? document.getElementById('chatbox-mobile') : document.getElementById('chatbox');
        box.removeChild(wait);
        throw err;
      }
      return data;
    }

    /* SILENT TOPICS */
    async function handleChoiceSilent(txt){
      console.log('[handleChoiceSilent]',txt);
      try{ await callAgent(txt); }catch(err){console.error(err);}
    }

    /* LOG QA */
    function logQA(qa){
      console.log('[logQA]',qa);
      const el = window.innerWidth<=600
        ? document.getElementById('q-and-a-mobile')
        : document.getElementById('q-and-a');
      el.innerHTML="";
      (qa||[]).forEach(item=>{
        const div=document.createElement("div");
        div.className="qa-item";
        div.innerHTML=`
          <div class="label">Thema: ${item.theme}</div>
          <div class="label">Vraag: <strong>${item.question}</strong></div>
          <div class="label">Antwoord: ${item.answer}</div>
        `;
        el.appendChild(div);
      });
    }

    /* DESKTOP LOADER & FLIP */
    function showLoader(){ document.getElementById('sidebar-loader').style.display='flex'; }
    function hideLoader(){ document.getElementById('sidebar-loader').style.display='none'; }
    const flipContainer = document.querySelector('.flip-container');
    function showFront() { flipContainer.className='flip-container'; }
    function showBack()  { flipContainer.className='flip-container show-back'; }
    function showThird() { flipContainer.className='flip-container show-third'; }

    /* MOBILE FLIP */
    const mobileFlip = document.getElementById('mobile-flip');
    function mobileShow(view){
      ['chat','themes','topics','qa'].forEach(v=>mobileFlip.classList.remove('show-'+v));
      mobileFlip.classList.add('show-'+view);
    }

    /* RENDER THEMES */
    function renderThemes(opts){
      console.log('[renderThemes]',opts);
      const box = window.innerWidth<=600
        ? document.getElementById('q-options-mobile')
        : document.getElementById('q-options');
      const tit = window.innerWidth<=600
        ? document.getElementById('q-title-mobile')
        : document.getElementById('q-title');
      box.innerHTML=""; tit.textContent="Kies een thema (max 6):";
      opts.forEach(o=>{
        const chip=document.createElement("span");
        chip.className="theme-chip"; chip.textContent=o.name;
        chip.onclick=()=>{
          console.log('[theme click]',o.name);
          if(window.innerWidth<=600) mobileShow('themes'); else showLoader();
          handleChoice(`Thema geselecteerd: ${o.name}`);
        };
        box.appendChild(chip);
      });
    }

    /* RENDER TOPICS */
    function renderTopicChips(options){
      console.log('[renderTopicChips]',options);
      const container = window.innerWidth<=600
        ? document.getElementById('q-topic-options-mobile')
        : document.getElementById('q-topic-options');
      container.innerHTML="";
      options.forEach(opt=>{
        const chip=document.createElement("span");
        chip.className="topic-chip"; chip.textContent=opt.name;
        chip.dataset.desc=opt.description||"";
        chip.onclick=()=>{
          chip.classList.toggle("selected");
          console.log('[topic toggle]',opt.name,chip.classList.contains("selected"));
          if(chip.classList.contains("selected")){
            if(selectedTopics.length<4) selectedTopics.push(opt.name);
            else chip.classList.remove("selected");
          } else {
            selectedTopics = selectedTopics.filter(t=>t!==opt.name);
          }
          const btn = window.innerWidth<=600
            ? document.getElementById('confirm-topics-mobile')
            : document.getElementById('confirm-topics');
          btn.disabled = selectedTopics.length===0;
        };
        container.appendChild(chip);
      });
    }

    /* BACK BUTTONS */
    document.getElementById('back-to-themes').onclick=async()=>{
      console.log('[back-to-themes] desktop');
      showLoader(); await new Promise(r=>setTimeout(r,300));
      hideLoader(); showFront();
    };
    document.getElementById('back-to-themes-mobile').onclick=()=>{
      console.log('[back-to-themes-mobile]'); mobileShow('chat');
    };
    document.getElementById('back-to-topics').onclick=()=>{
      console.log('[back-to-topics] desktop'); showBack();
    };
    document.getElementById('back-to-topics-mobile').onclick=()=>{
      console.log('[back-to-topics-mobile]'); mobileShow('themes');
    };

    /* CONFIRM TOPICS */
    async function confirmTopics(){
      console.log('[confirmTopics] topics:',selectedTopics);
      for(let t of selectedTopics){
        console.log('[confirmTopics] silent',t);
        await handleChoiceSilent(`Onderwerp geselecteerd: ${t}`);
      }
      await handleChoice(`Ik ben klaar met de onderwerpen voor ${currentTheme}.`);
      console.log('[confirmTopics] open Q&A'); showThird();
      if(window.innerWidth<=600){
        mobileShow('qa');
        document.getElementById('qa-tab').classList.add('new-qa');
      }
    }
    document.getElementById('confirm-topics').onclick=confirmTopics;
    document.getElementById('confirm-topics-mobile').onclick=confirmTopics;

    /* MAIN: CALL & RENDER */
    async function callAndRender(msg){
      console.log('[callAndRender] voor',msg);
      const data = await callAgent(msg);
      if(data.assistant_reply){
        console.log('[callAndRender] reply',data.assistant_reply);
        addMsg("bot",data.assistant_reply);
      }
      if(data.stage==="choose_theme"&&data.options){
        renderThemes(data.options);
        if(window.innerWidth>600){ hideLoader(); showFront(); }
        else { mobileShow('themes'); }
      }
      if(data.stage==="choose_topic"&&data.options&&data.current_theme){
        currentTheme=data.current_theme;
        window.uiTopicOptionsForTheme = data.options;
        if(window.innerWidth>600){
          showLoader();
          setTimeout(()=>{
            hideLoader(); showBack();
            renderTopicChips(data.options);
          },600);
        } else {
          mobileShow('topics');
          renderTopicChips(data.options);
        }
      }
      window._qa = data.qa||[];
      logQA(data.qa||[]);
  